{% extends 'base.html' %}
{% load static %}
{%include 'includes navbar.html'%}


{%block content%}

<article class="content">
    <div class="card card-block">
        <div id="notify" class="alert alert-success" style="display:none;">
            <a href="#" class="close" data-dismiss="alert">&times;</a>

            <div class="message"></div>
        </div>
        <form method="post" id="data_form">
            {% csrf_token %}
            <div class="row">

                <div class="col-sm-6 cmp-pnl">
                    <div id="customerpanel" class="inner-cmp-pnl">
                        <div class="form-group row">
                            <div class="fcol-sm-12">
                                <h3 class="title">
                                    Bill From 
                                    <a href='#' class="btn btn-primary btn-sm rounded" data-toggle="modal"
                                                data-target="#addSupplier">Add Supplier</a>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="frmSearch col-sm-12"><label for="cst" class="caption">Search Supplier</label>
                                <input required type="text" id="supplier-box" class="form-control"
                                 name="supplier" list="supplier-list">
                                <datalist id="supplier-list">
                                  <select id="suppliers" class="selectpicker form-control">
                                    {% for supplier in supplier_list%}
                                    <option value="{{supplier.supplier_name}}">{{supplier.supplier_name}}</option>
                                    {% endfor %}
                                  </select>
                                </datalist>
                                <div id="supplier-box-result"></div>
                            </div>
                        </div>

                        <div id="supplier">
                            <div class="clientinfo">
                                Supplier Details
                                <hr>
                                 <input type="hidden" name="customer_id" id="customer_id" value="">
                                <div id="supplier_name"><strong>Name</strong></div>
                            </div>

                            <div class="clientinfo">
                                <div id="supplier_address"><strong>Address<br></strong></div>
                            </div>

                            <div class="clientinfo">
                                <div type="text" id="supplier_phone">
                                    Phone: <strong></strong>
                                    <br>
                                    Email: <strong></strong>
                                </div>
                            </div>
                            
                                <hr>Warehouse
                                <input required type="text" class="form-control" name="facility" list="warehouse-list">
                                <datalist id="warehouse-list">
                                  <select id="warehouses" class="selectpicker form-control">
                                    {% for facility in facility_list%}
                                    <option value="{{facility.facility_name}}">{{facility.facility_name}}</option>
                                    {% endfor %}
                                  </select>
                                </datalist>
                                <br><br>
                        </div>
                        </div>
                    </div>
                    <div class="col-sm-6 cmp-pnl">
                        <div class="inner-cmp-pnl">
                            <div class="form-group row">
                                <div class="col-sm-12"><h3 class="title"> Purchase Order Properties</h3>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-6">
                                    <label for="invocieno" class="caption"> Purchase Order#</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="icon-file-text-o" aria-hidden="true"></span>
                                        </div>
                                        <!-- <input type="text" class="form-control" placeholder="Purchase Order #"
                                               name="invoiceno" value="{{new_order.purchase_order_id}}" readonly> -->
                                        {{po_form.purchase_order_id}}
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="invocieno" class="caption"> Reference</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="icon-bookmark-o" aria-hidden="true"></span>
                                        </div>
                                        {{po_form.reference_id}}
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-sm-6"><label for="invociedate" class="caption"> Order Date</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="icon-calendar4" aria-hidden="true"></span>
                                        </div>
                                        {{po_form.order_date}}
                                    </div>
                                </div>
                            </div>

                            <div class="form-group row">
                                <div class="col-sm-12">
                                    <label for="toAddInfo"
                                           class="caption">Order Note</label>
                                    <textarea class="form-control" name="notes"
                                              rows="2"></textarea></div>
                            </div>

                        </div>
                    </div>

                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-success" aria-label="Left Align"
                            data-toggle="tooltip" data-placement="top"
                             title="Add product row" id="addProduct">
                        <i class="icon-plus-square"></i> Add Row
                    </button>
                </div>
                {% if formset %}
                {{ formset.management_form }}
                <div id="saman-row" >
                    <table id="scrollable-table" class="table table-striped table-hover table-sm sortable" 
                                width="100%"> 
                        <thead >
                            <tr class="item_header">
                                <th width="30%" class="text-center">Item Name</th>
                                <th width="20%" class="text-center">Item Batch</th>
                                <th width="3%" class="text-center"> Expiration Date</th>
                                <th width="5%" class="text-center">Quantity</th>
                                <th width="3%" class="text-center">Cost Price</th>
                                <th width="3%" class="text-center">Discount</th>
                                <th width="3%" class="text-center">Total Amount</th>
                                <th width="1%" class="text-center">Action</th>
                            </tr>
                        </thead>

                        <tbody id="tbody">  

                                
                            <tr id="R1" class="form-rows">                      
                                <td>
                                    <input required type="text" class="form-control"
                                     id="productName" name="product" list="product-list" aria-required="true">
                                   <datalist id="product-list">
                                     <select id="products" class="selectpicker form-control">
                                       {% for product in product_list%}
                                       <option value="{{product.product_name}}">{{product.product_name}}</option>
                                       {% endfor %}
                                     </select>
                                   </datalist>
                                </td>
                                <td>
                                    <!-- <input type="text" class="form-control req amnt" name="" id=""
                                        onkeypress="" onkeyup="" autocomplete="off" value="" > -->
                                    {{formset.empty_form.batch_number}}
                                <td>
                                    <!-- <input type="text" class="form-control req prc" name="" id=""
                                    onkeypress="" onkeyup="" autocomplete="off" value="" > -->
                                    {{formset.empty_form.expiration_date}}
                                </td>
                                <td>
                                    <!-- <input type="text" class="form-control discount" name="" id=""
                                    onkeypress="" onkeyup="" autocomplete="off" value="" > -->
                                    {{formset.empty_form.supplied_qty}}
                                </td>
                                <td>
                                    <!-- <input type="text" class="form-control discount" name="" id=""
                                    onkeypress="" onkeyup="" autocomplete="off" value="" > -->
                                    {{formset.empty_form.cost_price}}
                                </td>
                                <td>
                                    {{formset.empty_form.discount}}
                                </td>

                                <td>
                                    <span class="currenty">GHS </span>
                                    <strong><span class='ttlText' id="result-0">0</span></strong>
                                </td>
                                
                                <td class="text-center">
                                    <button type="button" data-rowid="" 
                                    class="btn btn-danger removeProd" title="Remove">
                                        <i class="icon-minus-square"></i>
                                     </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- <div class="sub_c" style="display: table-row;">
                        <div colspan="6" align="right">
                            <strong>Total Discount</strong></div>
                        <div align="left" colspan="2"><span
                                    class="currenty lightMode"></span>
                            <span id="discs" class="lightMode"></span></div>
                    </div>

                    <div class="sub_c" style="display: table-row;">
                        <div colspan="6" align="right"><strong>Grand Total(<span
                                        class="currenty lightMode"></span>)</strong>
                        </div>
                        <div align="left" colspan="2">
                            <input type="text" name="total" 
                            class="form-control" id="invoiceyoghtml" value="" readonly="">
                        </div>
                    </div> -->

                    <div align="right" colspan="4">
                        <input type="submit" class="btn btn-success sub-btn"
                        value="Generate Order" id="submit-purchase-order" data-loading-text="Creating...">
                    </div>
                </div>
                {% endif %}

                <input type="hidden" value="add_purchase_order/" id="action-url">
                <input type="hidden" value="%" name="discountFormat" id="discount_format">
        </form>
    </div>

</article>

<div class="modal fade" id="addSupplier" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="product-action" class="form-horizontal" action="">
                {% csrf_token %}
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Add Supplier</h4>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    
                    <div id="statusMsg" role="alert"></div>
                   
                    
                    <input type="hidden" name="msupplier_id" id="msupplier_id" value="0">

                    <div class="form-group row">

                        <label class="col-sm-2 col-form-label"
                               for="name">Name</label>

                        <div class="col-sm-10">
                            {{supplier_form.supplier_name}}
                        </div>
                    </div>

                    <div class="form-group row">

                        <label class="col-sm-2 col-form-label"
                               for="phone">Phone</label>

                        <div class="col-sm-10">
                            {{supplier_form.phone_number}}
                        </div>
                    </div>

                    <div class="form-group row">

                        <label class="col-sm-2 col-form-label"
                               for="phone">Contact Person</label>

                        <div class="col-sm-10">
                            {{supplier_form.contact_person}}
                        </div>
                    </div>

                    <div class="form-group row">

                        <label class="col-sm-2 col-form-label" for="email">Email</label>

                        <div class="col-sm-10">
                            {{supplier_form.email}}
                        </div>
                    </div>
                    <div class="form-group row">

                        <label class="col-sm-2 col-form-label"
                               for="address">Address</label>

                        <div class="col-sm-10">
                            {{supplier_form.address}}
                        </div>
                    </div>
                    <div class="form-group row">


                        <div class="col-sm-6">
                            {{supplier_form.city}}
                        </div>
                        <div class="col-sm-6">
                            {{supplier_form.region}}
                        </div>

                    </div>

                    <div class="form-group row">


                        <div class="col-sm-6">
                            {{supplier_form.country}}
                        </div>

                        <div class="col-sm-6">
                            {{supplier_form.postbox}}
                        </div>
                    </div>


                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">Close</button>
                    <input type="submit" id="msupplier_add" class="btn btn-primary submitBtn"
                           value="ADD"/>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script type="text/javascript">

    const supplierResult = document.getElementById("supplier");
    const supplierName = document.getElementById("supplier_name")
    const supplierAddress = document.getElementById("supplier_address")
    const supplierPhone = document.getElementById("supplier_phone")
    const generateOrder = document.getElementById("submit-data")
    const csrf = document.getElementById("csrfmiddlewaretoken")
    
    supplierResult.style = "display: none"

    $('#tbody').delegate('tr', 'keyup', function()
    
    {
                        const numb = $(this).attr("id")[1] - 1;
                        console.log(typeof(numb));

                            //most res
                        var result;
                        var totalValue;
                        var amountVal = formInputGet2("#id_form", "supplied_qty", numb);
                        var priceVal = formInputGet2("#id_form", "cost_price", numb);
                        var discountVal = formInputGet2("#id_form", "discount", numb);
                        if(discountVal=='') { $("#id_form-" + numb + "-discount").val(0);discountVal=0;}
                        // var vatVal = formInputGet("#vat", numb);
                        // if(vatVal=='') { $("#vat-"+numb).val(0);vatVal=0;}
                        // var taxo = 0;
                        // var disco = 0;
                        var totalPrice = parseFloat(amountVal)*priceVal;
                        var tax_status = $("#tax_status").val();
                        var disFormat = $("#discount_format").val();
                        
                        console.log(numb)
                        console.log(amountVal)

                    if (disFormat == '%' || disFormat == 'flat') {
                        if (tax_status == 'yes') {
                            var Inpercentage = precentCalc(totalPrice, vatVal);
                            totalValue = parseFloat(totalPrice) + parseFloat(Inpercentage);
                            taxo = deciFormat(Inpercentage);
                        console.log('percetn'+Inpercentage);  console.log('ttl'+totalValue);  console.log('price'+totalPrice); }
                        else {
                            totalValue = deciFormat(totalPrice);
                        }
                        if (disFormat == 'flat') {
                            disco = deciFormat(discountVal);
                            totalValue = parseFloat(totalValue) - parseFloat(discountVal);
                        }
                        else if (disFormat == '%') {
                            var discount = precentCalc(totalValue, discountVal);
                            totalValue = parseFloat(totalValue) - parseFloat(discount);
                            disco = deciFormat(discount);
                        }
                        else {
                            totalValue = deciFormat(totalValue);
                        }
                    } else{
                    //before tax
                            if (disFormat == 'bflat') {
                            disco = deciFormat(discountVal);
                            totalValue = parseFloat(totalPrice) - parseFloat(discountVal);
                        }
                        else if (disFormat == 'b_p') {
                            var discount = precentCalc(totalPrice, discountVal);
                            totalValue = parseFloat(totalPrice) - parseFloat(discount);
                            disco = deciFormat(discount);
                        }
                        else {
                            totalValue = deciFormat(totalPrice);
                        }
                        if (tax_status == 'yes') {
                            var Inpercentage = precentCalc(totalValue, vatVal);
                            totalValue = parseFloat(totalValue) + parseFloat(Inpercentage);
                            taxo = deciFormat(Inpercentage);
                            }
                        else {
                            totalValue = deciFormat(totalValue);
                        }


                        }
                        $("#result-" + numb).html(deciFormat(totalValue));
                        // $("#taxa-" + numb).val(taxo);
                        // $("#texttaxa-" + numb).text(taxo);
                        // $("#disca-" + numb).val(disco);
                        var totalID = "#total-" + numb;
                        $(totalID).val(deciFormat(totalValue));
                    });
    
    

    $(document).ready(function () {
    
        $('#scrollable-table').DataTable({
        "scrollX":true,
        "scrollY": 300,
        "paging":false,
        "searching":false,
        "sorting":false
        });

        $('.dataTables_length').addClass('bs-select');

        const initialFormNum = document.getElementById("id_form-INITIAL_FORMS")
        initialFormNum.setAttribute('value', 0)


        function prefixChange(){
            const initialFormNum = document.getElementById("id_form-INITIAL_FORMS")
            initialFormNum.setAttribute('value', 0)

            const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')
            totalNewForms.setAttribute('value', 1)


            const forms = document.getElementsByClassName("form-rows")
            const regex = new RegExp('__prefix__', 'g')
            const fields = [...document.getElementsByClassName("product-form")];
            // console.log(fields[0])
            fields.forEach(element => 
            {   var name = String(element.name)
                if (name.indexOf('prefix') > -1)
                {
                element.name = element.name.replace(regex, "0")
                element.id = element.id.replace(regex, "0")
                }
            });
        }
        
        prefixChange()
        
        function formSetFunc()
        {
            const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')
            console.log(totalNewForms)

            const forms = document.getElementsByClassName("form-rows")
            const currentFormCount = forms.length 

            console.log(currentFormCount)
            const regex = new RegExp('__prefix__', 'g')
            const fields = [...document.getElementsByClassName("product-form")];
            console.log(fields[0])
            fields.forEach(element => 
            {   var name = String(element.name)
                if (name.indexOf('prefix') > -1)
                {
                element.name = element.name.replace(regex, currentFormCount-1);
                element.id = element.id.replace(regex, currentFormCount-1);
                }
            });

            totalNewForms.setAttribute('value', currentFormCount)
            }

        
    // Denotes total number of rows
    var rowIdx = 1;

    // jQuery button click event to add a row
        $('#addProduct').on('click', function () {
        console.log('clicked')
        // Adding a row inside the tbody.
        $('#tbody').append(`
            <tr id="R${++rowIdx}" class="form-rows">                     
                <td> <input required type="text" class="form-control"
                    id="productName" name="product" list="product-list" aria-required="true">
                    <datalist id="product-list">
                        <select id="products" class="selectpicker form-control">
                        {% for product in product_list%}
                        <option value="{{product.product_name}}">{{product.product_name}}</option>
                        {% endfor %}
                        </select>
                    </datalist>
                </td>
                <td>
                    {{formset.empty_form.batch_number}}
                </td>
                <td>
                    {{formset.empty_form.expiration_date}}
                </td>
                <td>
                    {{formset.empty_form.supplied_qty}}
                </td>
                <td>
                    {{formset.empty_form.cost_price}}
                </td>

                <td>
                    {{formset.empty_form.discount}}
                </td>

                < <td>
                    <span class="currenty">GHS </span>
                    <strong><span class='ttlText' id="result-${rowIdx-1}">0</span></strong>
                </td>

                <td class="text-center">
                    <button type="button" data-rowid="" 
                    class="btn btn-danger removeProd" title="Remove">
                        <i class="icon-minus-square"></i>
                        </button>
                </td>
            </tr>
            `);
            formSetFunc()
        });
    
        // jQuery button click event to remove a row.
        $('#tbody').on('click', '.remove', function () {

            // Getting all the rows next to the row
            // containing the clicked button
            var child = $(this).closest('tr').nextAll();

            // Iterating across all the rows 
            // obtained to change the index
            child.each(function () {

                // Getting <tr> id.
                var id = $(this).attr('id');

                // Getting the <p> inside the .row-index class.
                var idx = $(this).children('.row-index').children('p');

                // Gets the row number from <tr> id.
                var dig = parseInt(id.substring(1));

                // Modifying row index.
                idx.html(`Row ${dig - 1}`);

                // Modifying row id.
                $(this).attr('id', `R${dig - 1}`);
            });

            // Removing the current row.
            $(this).closest('tr').remove();

            // Decreasing total number of rows by 1.
            rowIdx--;
            });
        

        $("#supplier-box").keyup(function () {
            console.log('active')
            $.ajax({
                type: "GET",
                url: 'get_supplier/',
                data: 'keyword=' + $(this).val(),
                beforeSend: function () {
                    $("#supplier-box").css("background", "#FFF url(% static 'css/custom/load-ring.gif' %) no-repeat 165px");
                    supplierResult.style = "display: none"
                },
                success: function (response) {
                    const data = response.data
                    console.log(data[0])
                    if(data !== "Not found"){
                        supplierResult.style = ""
                        supplierName.innerHTML = `Name: <strong>${data[0].supplier}</strong>`
                        supplierAddress.innerHTML = `Address: <strong>${data[0].address}</strong>`
                        supplierPhone.innerHTML = `Phone: <strong>${data[0].phone}</strong>
                                                        <br>
                                                Email: <strong>${data[0].email}</strong>`

                    }
                },
                error: function(error){
                    console.log(error)
                }
            });
        });


        

    function total(){
        var table = document.getElementById('displayTable');
        let total = 0
        for(let i = 1; i<table.rows.length; i++){
            total+=Number(table.rows[i].cells[2].innerText)
        }
        const totalInput = document.getElementById('total')
        totalInput.value=total

    }

    
        
    });


</script>
{% endblock scripts %}


{% endblock %}

{%include 'includes/footer.html' %}